name: Pull Request Validation

on:
  pull_request:
    branches: [main, develop]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Check code formatting
        run: npm run format:check

      - name: Run TypeScript compiler
        run: npx tsc --noEmit

      - name: Run tests with coverage
        run: npm run test

      - name: Build project
        run: npm run build

      - name: Check bundle size
        run: |
          BUILD_SIZE=$(du -sh dist | cut -f1)
          echo "Build size: $BUILD_SIZE"

          # Check if any file is larger than 500KB
          LARGE_FILES=$(find dist -type f -size +500k || true)
          if [ -n "$LARGE_FILES" ]; then
            echo "âš ï¸ Warning: Large files found (>500KB):"
            echo "$LARGE_FILES"
          fi

      - name: Comment PR with build info
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            const buildSize = execSync('du -sh dist').toString().split('\t')[0];

            const comment = `## Build Validation âœ…

            - âœ… Linting passed
            - âœ… Formatting correct
            - âœ… TypeScript compilation successful
            - âœ… All tests passed
            - âœ… Build completed

            **Build size:** ${buildSize}

            Ready to merge! ðŸš€`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
